<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Itaú CTF · Transporte Opcional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
</head>
<body>
  <header>
    <div class="brand" role="img" aria-label="Itaú CTF">
      <div class="brand-badge" aria-hidden="true"><span>i</span></div>
      <div class="brand-title">
        <div class="eyebrow">Itaú CTF</div>
        <h1>Transporte Opcional</h1>
      </div>
    </div>
    <p>Uma captura de rede revelou que o gateway aceita downgrade de protocolo. Use o material compartilhado para
      reproduzir o fluxo completo antes de pedir a sessão.</p>
  </header>

  <main>
    <section>
      <h2>Captura de referência</h2>
      <p>
        Baixe a captura <a href="{{ url_for('static', filename='assets/handshake.log') }}">handshake.log</a> e analise
        o código do bilhete e o protocolo usado na requisição legítima.
      </p>
    </section>

    <section>
      <h2>Iniciar handshake</h2>
      <form id="login-form" aria-describedby="login-help">
        <p id="login-help" class="sr-only">Informe o código do bilhete e o protocolo esperado pelo gateway.</p>
        <label for="ticket">Código do bilhete</label>
        <input id="ticket" name="ticket" placeholder="BOARDING-????" required />

        <label for="proto">Protocolo encaminhado</label>
        <select id="proto" name="proto">
          <option value="https">https</option>
          <option value="http">http</option>
        </select>

        <button type="submit">Enviar handshake</button>
      </form>
      <p id="login-output" aria-live="polite">Nenhum handshake iniciado.</p>
    </section>

    <section aria-live="polite" aria-atomic="true">
      <h2>Criar sessão</h2>
      <button id="session-btn" disabled>Solicitar sessão</button>
      <pre id="session-output" role="status">Informe o bilhete válido para liberar a sessão.</pre>
    </section>
  </main>

  <footer>
    © 2025 CECyber Play Labs - Itaú CTF · <a href="/health">Healthcheck</a>
  </footer>

  <script>
    let handshakeToken = null;

    const sessionButton = document.getElementById('session-btn');
    const sessionOutput = document.getElementById('session-output');
    const loginForm = document.getElementById('login-form');
    const loginOutput = document.getElementById('login-output');

    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const ticket = document.getElementById('ticket').value.trim();
      const proto = document.getElementById('proto').value;

      if (!ticket) {
        loginOutput.textContent = 'Informe o código do bilhete.';
        return;
      }

      loginOutput.textContent = 'Enviando handshake...';

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Forwarded-Proto': proto
          },
          body: JSON.stringify({ ticket })
        });
        const data = await res.json();
        if (!res.ok) {
          loginOutput.textContent = data.error ? `Erro: ${data.error}` : 'Handshake recusado.';
          sessionButton.disabled = true;
          handshakeToken = null;
          return;
        }

        handshakeToken = data.handshake_token;
        sessionButton.disabled = false;
        loginOutput.textContent = `Handshake aprovado. Token válido por ${data.expires_in} segundos.`;
        sessionOutput.textContent = 'Token liberado. Solicite a sessão para ver a resposta.';
      } catch (error) {
        loginOutput.textContent = 'Erro: ' + error;
        sessionButton.disabled = true;
        handshakeToken = null;
      }
    });

    sessionButton.addEventListener('click', async () => {
      if (!handshakeToken) {
        sessionOutput.textContent = 'Gere um handshake primeiro.';
        return;
      }

      sessionOutput.textContent = 'Solicitando sessão...';

      try {
        const res = await fetch('/session', {
          headers: { 'X-Transit-Token': handshakeToken }
        });
        const data = await res.json();
        if (!res.ok) {
          sessionOutput.textContent = data.error ? `Erro: ${data.error}` : 'Sessão negada.';
          return;
        }

        sessionOutput.textContent = JSON.stringify(data, null, 2);
        handshakeToken = null;
        sessionButton.disabled = true;
      } catch (error) {
        sessionOutput.textContent = 'Erro: ' + error;
      }
    });
  </script>
</body>
</html>
