<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Itaú CTF · Bypass de MFA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
</head>
<body>
  <header>
    <div class="brand" role="img" aria-label="Itaú CTF">
      <div class="brand-badge" aria-hidden="true"><span>i</span></div>
      <div class="brand-title">
        <div class="eyebrow">Itaú CTF</div>
        <h1>Central MFA - Operações</h1>
      </div>
    </div>
    <p>O fluxo de autenticação em três etapas foi improvisado e depende de informações manipuláveis pelo cliente.</p>
  </header>

  <main>
    <section>
      <h2>1. Validar credenciais</h2>
      <label>Usuário <input id="user" value="analyst"></label>
      <label>Senha <input id="pass" value="senh@F0rte" type="password"></label>
      <button id="start">Iniciar sessão</button>
    </section>

    <section>
      <h2>2. Token MFA</h2>
      <label>Código <input id="code" value=""></label>
      <button id="mfa">Enviar token</button>
    </section>

    <section>
      <h2>3. Finalizar</h2>
      <label>Session ID <input id="session"></label>
      <label>Etapa <input id="step"></label>
      <button id="complete">Finalizar login</button>
    </section>

    <section aria-live="polite">
      <h2>Logs</h2>
      <pre id="log">Acompanhe o fluxo e questione como o servidor confere as etapas.</pre>
    </section>
  </main>

  <footer>
    © 2025 CECyber Play Labs - Itaú CTF · <a href="/health">Healthcheck</a>
  </footer>

  <script>
    let currentSession = null;

    async function call(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      return { status: res.status, data };
    }

    const log = (msg) => {
      const output = document.getElementById('log');
      output.textContent += '\n' + msg;
    };

    document.getElementById('start').addEventListener('click', async () => {
      const username = document.getElementById('user').value;
      const password = document.getElementById('pass').value;
      const resp = await call('/api/start', { username, password });
      log('Start: ' + JSON.stringify(resp));
      if (resp.status === 200) {
        currentSession = resp.data.session_id;
        document.getElementById('session').value = currentSession;
      }
    });

    document.getElementById('mfa').addEventListener('click', async () => {
      const resp = await call('/api/mfa', {
        session_id: document.getElementById('session').value,
        code: document.getElementById('code').value
      });
      log('MFA: ' + JSON.stringify(resp));
      if (resp.status === 200) {
        document.getElementById('step').value = 'mfa_ok';
      }
    });

    document.getElementById('complete').addEventListener('click', async () => {
      const resp = await call('/api/complete', {
        session_id: document.getElementById('session').value,
        step: document.getElementById('step').value
      });
      log('Complete: ' + JSON.stringify(resp));
    });
  </script>
</body>
</html>
